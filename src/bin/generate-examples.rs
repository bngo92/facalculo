use std::{
    collections::{HashMap, HashSet},
    fs,
};

use facalculo::{
    data::{self, Data},
    module::{Module, NamedModule},
};

fn main() -> Result<(), Box<dyn std::error::Error>> {
    let b = include_bytes!("../data-raw-dump.json");
    let data: Data = serde_json::from_slice(b)?;
    let recipe_rates = data::calculate_rates(&data);
    fs::write(
        "examples/base/copper-ore.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "copper-ore",
            true,
            &[],
            &HashSet::new(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/copper-plate.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "copper-plate",
            true,
            &["copper-ore"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &HashSet::new(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/iron-ore.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "iron-ore",
            true,
            &[],
            &HashSet::new(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/iron-plate.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "iron-plate",
            true,
            &["iron-ore"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &HashSet::new(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/automation-science-pack.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "automation-science-pack",
            true,
            &["copper-plate", "iron-plate"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &["iron-gear-wheel"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/electronic-circuit.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "electronic-circuit",
            true,
            &["copper-plate", "iron-plate"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &["copper-cable"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/logistic-science-pack.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "logistic-science-pack",
            true,
            &["iron-plate", "electronic-circuit"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &["iron-gear-wheel"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/steel-plate.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "steel-plate",
            true,
            &["iron-plate"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &HashSet::new(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/coal.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "coal",
            true,
            &[],
            &HashSet::new(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/stone.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "stone",
            true,
            &[],
            &HashSet::new(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/military-science-pack.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "military-science-pack",
            true,
            &["iron-plate", "steel-plate", "copper-plate", "coal", "stone"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &HashSet::new(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/water.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "water",
            true,
            &[],
            &HashSet::new(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/crude-oil.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "crude-oil",
            true,
            &[],
            &HashSet::new(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/advanced-oil-processing.json",
        serde_json::to_string_pretty(&NamedModule {
            name: "advanced-oil-processing".to_owned(),
            module: Module::AdvancedOilProcessing {},
        })?,
    )?;
    fs::write(
        "examples/plastic-bar.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "plastic-bar",
            true,
            &["petroleum-gas", "coal"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &[].into_iter().collect(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/advanced-circuit.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "advanced-circuit",
            true,
            &["copper-plate", "electronic-circuit", "plastic-bar"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &["copper-cable"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/sulfur.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "sulfur",
            true,
            &["water", "petroleum-gas", "coal"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &HashSet::new(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/chemical-science-pack.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "chemical-science-pack",
            true,
            &[
                "iron-plate",
                "electronic-circuit",
                "steel-plate",
                "plastic-bar",
                "advanced-circuit",
                "sulfur",
            ]
            .into_iter()
            .map(ToOwned::to_owned)
            .collect::<Vec<_>>(),
            &["iron-gear-wheel", "pipe"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/production-science-pack.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "production-science-pack",
            true,
            &[
                "iron-plate",
                "electronic-circuit",
                "steel-plate",
                "plastic-bar",
                "advanced-circuit",
                "stone",
            ]
            .into_iter()
            .map(ToOwned::to_owned)
            .collect::<Vec<_>>(),
            &["iron-stick"].into_iter().map(ToOwned::to_owned).collect(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/sulfuric-acid.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "sulfuric-acid",
            true,
            &["sulfur", "iron-plate", "water"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &["sulfuric-acid"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/processing-unit.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "processing-unit",
            true,
            &["electronic-circuit", "advanced-circuit", "sulfuric-acid"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &HashSet::new(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/low-density-structure.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "low-density-structure",
            true,
            &["steel-plate", "copper-plate", "plastic-bar"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &["low-density-structure"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/base/utility-science-pack.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "utility-science-pack",
            true,
            &[
                "steel-plate",
                "copper-plate",
                "low-density-structure",
                "iron-plate",
                "processing-unit",
                "heavy-oil",
                "electronic-circuit",
                "sulfuric-acid",
            ]
            .into_iter()
            .map(ToOwned::to_owned)
            .collect::<Vec<_>>(),
            &["iron-gear-wheel", "pipe", "lubricant"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/space-science-pack/space-science-pack.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "space-science-pack",
            true,
            &[
                "metallic-asteroid-chunk",
                "carbonic-asteroid-chunk",
                "oxide-asteroid-chunk",
            ]
            .into_iter()
            .map(ToOwned::to_owned)
            .collect::<Vec<_>>(),
            &[
                "iron-plate",
                "metallic-asteroid-crushing",
                "carbonic-asteroid-crushing",
                "oxide-asteroid-crushing",
            ]
            .into_iter()
            .map(ToOwned::to_owned)
            .collect(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/science.json",
        serde_json::to_string_pretty(&NamedModule {
            name: "science".to_owned(),
            module: Module::Science {
                modules: HashMap::new(),
                research_speed: None,
                research_time: None,
            },
        })?,
    )?;
    fs::write(
        "examples/rocket/rocket-fuel.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "rocket-fuel",
            true,
            &["light-oil"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &["solid-fuel-from-light-oil", "rocket-fuel"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/rocket/rocket-silo.json",
        serde_json::to_string_pretty(&NamedModule {
            name: "rocket-silo".to_owned(),
            module: Module::RocketSilo {
                modules: HashMap::new(),
            },
        })?,
    )?;
    fs::write(
        "examples/foundry/molten-iron.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "molten-iron",
            true,
            &["iron-ore", "calcite"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &HashSet::new(),
            &recipe_rates,
        )?)?,
    )?;
    fs::write(
        "examples/foundry/molten-copper.json",
        serde_json::to_string_pretty(&facalculo::generate(
            "molten-copper",
            true,
            &["copper-ore", "calcite"]
                .into_iter()
                .map(ToOwned::to_owned)
                .collect::<Vec<_>>(),
            &HashSet::new(),
            &recipe_rates,
        )?)?,
    )?;
    Ok(())
}
